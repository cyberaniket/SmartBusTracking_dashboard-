{% extends "base.html" %}

{% block title %}Stops - Smart Bus Tracking System{% endblock %}

{% block head %}
<style>
    #stop-map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
    }
    .stop-detail-map {
        height: 250px;
        border-radius: 4px;
    }
    #pickLocationMap {
        height: 200px;
        border-radius: 4px;
    }
    .address-suggestions {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h3"><i class="fas fa-map-marker-alt me-2"></i>Stop Management</h1>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStopModal">
                <i class="fas fa-plus me-1"></i> Add New Stop
            </button>
        </div>
    </div>
</div>

<!-- Map View -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-map me-2"></i>Stops Map</h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-stops-map">
                        <i class="fas fa-sync-alt me-1"></i> Refresh
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="center-stops-map">
                        <i class="fas fa-crosshairs me-1"></i> Center
                    </button>
                </div>
            </div>
            <div class="card-body p-0 position-relative">
                <!-- Map Search Bar -->
                <div class="position-absolute top-0 start-0 m-3" style="z-index: 1000; width: 350px;">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="fas fa-search text-primary"></i>
                        </span>
                        <input type="text" class="form-control" id="mapSearchInput" 
                               placeholder="Search locations to add as bus stops...">
                        <button class="btn btn-primary" type="button" id="addFromSearchBtn" disabled>
                            <i class="fas fa-plus me-1"></i> Add Stop
                        </button>
                    </div>
                    <small class="text-muted ms-2">Search and click "Add Stop" to quickly add new bus stops</small>
                </div>
                <div id="stop-map"></div>
            </div>
        </div>
    </div>
</div>

<!-- Stop List -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">All Stops</h5>
                    <div class="input-group" style="width: 300px;">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="stopSearch" placeholder="Search stops...">
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Stop Code</th>
                                <th>Name</th>
                                <th>Address</th>
                                <th>Coordinates</th>
                                <th>Status</th>
                                <th>Routes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stopTableBody">
                            {% if stops %}
                                {% for stop in stops %}
                                <tr data-stop-id="{{ stop.id }}">
                                    <td>{{ stop.stop_code }}</td>
                                    <td>{{ stop.name }}</td>
                                    <td>{{ stop.address or 'N/A' }}</td>
                                    <td>
                                        <small class="text-muted">
                                            {{ "%.4f"|format(stop.latitude) }}, {{ "%.4f"|format(stop.longitude) }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if stop.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if stop.route_stops|length > 0 %}
                                            <span class="badge bg-info">{{ stop.route_stops|length }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">None</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-info view-stop" data-stop-id="{{ stop.id }}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-primary edit-stop" data-stop-id="{{ stop.id }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger delete-stop" data-stop-id="{{ stop.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <p class="mb-0 text-muted">No stops found in the system</p>
                                        <button class="btn btn-sm btn-outline-primary mt-2" data-bs-toggle="modal" data-bs-target="#addStopModal">
                                            <i class="fas fa-plus me-1"></i> Add Your First Stop
                                        </button>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Stop Modal -->
<div class="modal fade" id="addStopModal" tabindex="-1" aria-labelledby="addStopModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStopModalLabel">Add New Stop</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addStopForm">
                    <div class="mb-3">
                        <label for="stopCode" class="form-label">Stop Code</label>
                        <input type="text" class="form-control" id="stopCode" required>
                        <div class="form-text">Unique identifier for the stop</div>
                    </div>
                    <div class="mb-3">
                        <label for="stopName" class="form-label">Stop Name</label>
                        <input type="text" class="form-control" id="stopName" required>
                    </div>
                    <div class="mb-3">
                        <label for="stopAddress" class="form-label">Address</label>
                        <input type="text" class="form-control" id="stopAddress" placeholder="Start typing address...">
                        <div class="form-text">Address will be auto-completed as you type using Google Places</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="stopLatitude" class="form-label">Latitude</label>
                            <input type="number" step="0.000001" class="form-control" id="stopLatitude" required>
                        </div>
                        <div class="col-6">
                            <label for="stopLongitude" class="form-label">Longitude</label>
                            <input type="number" step="0.000001" class="form-control" id="stopLongitude" required>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            Stop is active
                        </label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pick Location on Map</label>
                        <div id="pickLocationMap" style="height: 200px;"></div>
                        <div class="form-text mt-2">Click on the map to set the stop location</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveStopBtn">Save Stop</button>
            </div>
        </div>
    </div>
</div>

<!-- View Stop Modal -->
<div class="modal fade" id="viewStopModal" tabindex="-1" aria-labelledby="viewStopModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewStopModalLabel">Stop Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Stop Code:</span>
                                        <span id="viewStopCode" class="fw-bold"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Name:</span>
                                        <span id="viewStopName" class="fw-bold"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Status:</span>
                                        <span id="viewStopStatus"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Address:</span>
                                        <span id="viewStopAddress"></span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between">
                                        <span>Coordinates:</span>
                                        <span id="viewStopCoordinates" class="fw-bold"></span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">Location</h6>
                            </div>
                            <div class="card-body">
                                <div id="viewStopMap" class="stop-detail-map"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Routes Serving This Stop</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table mb-0">
                                        <thead>
                                            <tr>
                                                <th>Route</th>
                                                <th>Sequence</th>
                                                <th>Scheduled Arrival</th>
                                                <th>Scheduled Departure</th>
                                                <th>Distance from Start</th>
                                            </tr>
                                        </thead>
                                        <tbody id="viewStopRoutesTable">
                                            <!-- Routes will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Upcoming Buses</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table mb-0">
                                        <thead>
                                            <tr>
                                                <th>Bus</th>
                                                <th>Route</th>
                                                <th>ETA</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="viewStopBusesTable">
                                            <!-- Upcoming buses will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let map, stopsMap, pickLocationMap;
    let autocompleteService;
    let geocoder;
    let placesService;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the stops map
        initStopsMap();
        
        // Initialize address autocomplete when Google Maps is ready
        if (typeof google !== 'undefined' && google.maps) {
            initAddressAutocomplete();
        } else {
            window.addEventListener('googleMapsReady', function() {
                initAddressAutocomplete();
            });
        }
        
        // Set up event listeners
        document.getElementById('saveStopBtn').addEventListener('click', saveStop);
        document.getElementById('refresh-stops-map').addEventListener('click', refreshStopsMap);
        document.getElementById('center-stops-map').addEventListener('click', centerStopsMap);
        
        // Set up event listeners for view/edit/delete buttons
        document.querySelectorAll('.view-stop').forEach(button => {
            button.addEventListener('click', function() {
                const stopId = this.getAttribute('data-stop-id');
                viewStop(stopId);
            });
        });
        
        document.querySelectorAll('.edit-stop').forEach(button => {
            button.addEventListener('click', function() {
                const stopId = this.getAttribute('data-stop-id');
                editStop(stopId);
            });
        });
        
        document.querySelectorAll('.delete-stop').forEach(button => {
            button.addEventListener('click', function() {
                const stopId = this.getAttribute('data-stop-id');
                deleteStop(stopId);
            });
        });
        
        // Set up search functionality
        document.getElementById('stopSearch').addEventListener('input', function() {
            const searchText = this.value.toLowerCase();
            const rows = document.querySelectorAll('#stopTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchText) ? '' : 'none';
            });
        });
        
        // Initialize Google Maps for adding stops
        window.pickLocationMap = new google.maps.Map(document.getElementById('pickLocationMap'), {
            center: { lat: 20.5937, lng: 78.9629 },
            zoom: 13,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });
        
        window.pickLocationMarker = null;
        
        window.pickLocationMap.addListener('click', function(e) {
            // Update form fields with coordinates
            document.getElementById('stopLatitude').value = e.latLng.lat().toFixed(6);
            document.getElementById('stopLongitude').value = e.latLng.lng().toFixed(6);
            
            // Update or add marker
            if (window.pickLocationMarker) {
                window.pickLocationMarker.setPosition(e.latLng);
            } else {
                window.pickLocationMarker = new google.maps.Marker({
                    position: e.latLng,
                    map: window.pickLocationMap,
                    title: 'Selected Location'
                });
            }
        });
        
        // Reinitialize map when modal is shown
        document.getElementById('addStopModal').addEventListener('shown.bs.modal', function() {
            // Trigger resize for Google Maps
            google.maps.event.trigger(window.pickLocationMap, 'resize');
            
            // Use current map center or user location as starting point
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        pickLocationMap.setView([position.coords.latitude, position.coords.longitude], 15);
                    },
                    error => {
                        console.warn('Geolocation error:', error);
                    }
                );
            }
        });
    });
    
    function initAddressAutocomplete() {
        // Wait for Google Maps to be available
        function setupAutocomplete() {
            try {
                const addressInput = document.getElementById('stopAddress');
                
                // Create autocomplete object, restricting search to India
                const autocomplete = new google.maps.places.Autocomplete(addressInput, {
                    componentRestrictions: { country: 'in' },
                    types: ['establishment', 'geocode'],
                    fields: ['place_id', 'geometry', 'name', 'formatted_address']
                });
                
                // Listen for the event fired when the user selects a prediction
                autocomplete.addListener('place_changed', function() {
                    const place = autocomplete.getPlace();
                    
                    if (!place.geometry || !place.geometry.location) {
                        console.log("No location details available");
                        return;
                    }
                    
                    // Auto-fill coordinates
                    const lat = place.geometry.location.lat();
                    const lng = place.geometry.location.lng();
                    
                    document.getElementById('stopLatitude').value = lat.toFixed(6);
                    document.getElementById('stopLongitude').value = lng.toFixed(6);
                    
                    // Auto-fill stop name if empty
                    const stopNameInput = document.getElementById('stopName');
                    if (!stopNameInput.value.trim()) {
                        stopNameInput.value = place.name || extractLocationName(place.formatted_address);
                    }
                    
                    // Show success feedback
                    showAddressSelectedFeedback();
                });
                
                console.log('Google Places Autocomplete initialized successfully');
            } catch (error) {
                console.error('Error initializing autocomplete:', error);
            }
        }
        
        // Check if Google Maps is available
        if (typeof google !== 'undefined' && google.maps && google.maps.places) {
            setupAutocomplete();
        } else {
            // Wait for Google Maps to load
            window.addEventListener('googleMapsReady', setupAutocomplete);
            // Also try with a timeout as backup
            setTimeout(() => {
                if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                    setupAutocomplete();
                }
            }, 2000);
        }
    }
    
    function extractLocationName(formattedAddress) {
        // Extract a meaningful location name from formatted address
        const parts = formattedAddress.split(',');
        return parts[0].trim() + ' Bus Stop';
    }
    
    function searchAddresses(query, autocompleteService) {
        const request = {
            input: query,
            componentRestrictions: { country: 'in' }, // Restrict to India
            types: ['address', 'establishment', 'geocode']
        };
        
        autocompleteService.getPlacePredictions(request, (predictions, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                displaySuggestions(predictions);
            } else {
                hideSuggestions();
            }
        });
    }
    
    function displaySuggestions(predictions) {
        const suggestionsContainer = document.getElementById('addressSuggestions');
        suggestionsContainer.innerHTML = '';
        
        predictions.slice(0, 5).forEach(prediction => {
            const suggestionItem = document.createElement('a');
            suggestionItem.href = '#';
            suggestionItem.className = 'list-group-item list-group-item-action';
            suggestionItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${prediction.structured_formatting.main_text}</h6>
                    <small><i class="fas fa-map-marker-alt text-primary"></i></small>
                </div>
                <p class="mb-1 text-muted small">${prediction.structured_formatting.secondary_text}</p>
            `;
            
            suggestionItem.addEventListener('click', function(e) {
                e.preventDefault();
                selectAddress(prediction);
            });
            
            suggestionsContainer.appendChild(suggestionItem);
        });
        
        suggestionsContainer.style.display = 'block';
    }
    
    function selectAddress(prediction) {
        const addressInput = document.getElementById('stopAddress');
        addressInput.value = prediction.description;
        
        // Get detailed information including coordinates using Geocoder
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ placeId: prediction.place_id }, (results, status) => {
            if (status === 'OK') {
                const place = results[0];
                
                // Auto-fill coordinates
                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();
                
                document.getElementById('stopLatitude').value = lat.toFixed(6);
                document.getElementById('stopLongitude').value = lng.toFixed(6);
                
                // Auto-fill stop name if empty
                const stopNameInput = document.getElementById('stopName');
                if (!stopNameInput.value.trim()) {
                    stopNameInput.value = prediction.structured_formatting.main_text;
                }
                
                // Show success feedback
                showAddressSelectedFeedback();
                
                // Update pick location map if modal is open
                const modal = document.getElementById('addStopModal');
                if (modal.classList.contains('show')) {
                    updatePickLocationMap(lat, lng);
                }
            }
        });
        
        hideSuggestions();
    }
    
    function hideSuggestions() {
        document.getElementById('addressSuggestions').style.display = 'none';
    }
    
    function showAddressSelectedFeedback() {
        const addressInput = document.getElementById('stopAddress');
        const originalClass = addressInput.className;
        
        addressInput.className = originalClass + ' is-valid';
        
        setTimeout(() => {
            addressInput.className = originalClass;
        }, 2000);
    }
    
    function updatePickLocationMap(lat, lng) {
        // Update the pick location map with new coordinates
        if (window.pickLocationMap && window.pickLocationMarker) {
            const newPosition = { lat: lat, lng: lng };
            window.pickLocationMarker.setPosition(newPosition);
            window.pickLocationMap.setCenter(newPosition);
            window.pickLocationMap.setZoom(16);
        }
    }
    
    // Initialize the stops map using Google Maps
    function initStopsMap() {
        if (typeof google !== 'undefined' && google.maps) {
            setupGoogleStopsMap();
        } else {
            window.addEventListener('googleMapsReady', setupGoogleStopsMap);
        }
    }
    
    function setupGoogleStopsMap() {
        window.stopsMap = new google.maps.Map(document.getElementById('stop-map'), {
            center: { lat: 20.5937, lng: 78.9629 }, // Center on India
            zoom: 6,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ]
        });
        
        window.stopsMarkers = [];
        
        // Initialize map search functionality
        initMapSearch();
        
        // Load stops from API
        loadStopsOnMap();
    }
    
    function initMapSearch() {
        const searchInput = document.getElementById('mapSearchInput');
        const addBtn = document.getElementById('addFromSearchBtn');
        let selectedPlace = null;
        
        // Create autocomplete for map search
        const autocomplete = new google.maps.places.Autocomplete(searchInput, {
            componentRestrictions: { country: 'in' },
            types: ['establishment', 'geocode'],
            fields: ['place_id', 'geometry', 'name', 'formatted_address']
        });
        
        // When user selects a place from search
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            
            if (!place.geometry || !place.geometry.location) {
                return;
            }
            
            selectedPlace = place;
            addBtn.disabled = false;
            addBtn.classList.remove('btn-secondary');
            addBtn.classList.add('btn-success');
            
            // Center map on selected location
            window.stopsMap.setCenter(place.geometry.location);
            window.stopsMap.setZoom(16);
            
            // Add temporary marker
            if (window.tempMarker) {
                window.tempMarker.setMap(null);
            }
            
            window.tempMarker = new google.maps.Marker({
                position: place.geometry.location,
                map: window.stopsMap,
                title: 'Click "Add Stop" to add this location',
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                    scaledSize: new google.maps.Size(32, 32)
                },
                animation: google.maps.Animation.BOUNCE
            });
            
            setTimeout(() => {
                if (window.tempMarker) {
                    window.tempMarker.setAnimation(null);
                }
            }, 2000);
        });
        
        // Handle "Add Stop" button click
        addBtn.addEventListener('click', function() {
            if (selectedPlace) {
                addStopFromSearch(selectedPlace);
            }
        });
        
        // Reset button when search is cleared
        searchInput.addEventListener('input', function() {
            if (!this.value.trim()) {
                addBtn.disabled = true;
                addBtn.classList.remove('btn-success');
                addBtn.classList.add('btn-secondary');
                selectedPlace = null;
                
                if (window.tempMarker) {
                    window.tempMarker.setMap(null);
                    window.tempMarker = null;
                }
            }
        });
    }
    
    function addStopFromSearch(place) {
        // Auto-generate stop code
        const stopCode = 'ST' + Date.now().toString().slice(-6);
        
        const stopData = {
            stop_code: stopCode,
            name: place.name || extractLocationName(place.formatted_address),
            address: place.formatted_address,
            latitude: place.geometry.location.lat(),
            longitude: place.geometry.location.lng(),
            is_active: true
        };
        
        // Show loading state
        const addBtn = document.getElementById('addFromSearchBtn');
        const originalText = addBtn.innerHTML;
        addBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Adding...';
        addBtn.disabled = true;
        
        // Save stop using API
        fetch('/api/stops/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(stopData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; width: 300px;';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    Stop "${stopData.name}" added successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Reset search
                document.getElementById('mapSearchInput').value = '';
                addBtn.innerHTML = originalText;
                addBtn.disabled = true;
                addBtn.classList.remove('btn-success');
                addBtn.classList.add('btn-secondary');
                
                // Remove temp marker
                if (window.tempMarker) {
                    window.tempMarker.setMap(null);
                    window.tempMarker = null;
                }
                
                // Refresh the map to show new stop
                setTimeout(() => {
                    loadStopsOnMap();
                    alertDiv.remove();
                }, 3000);
                
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Reset button
            addBtn.innerHTML = originalText;
            addBtn.disabled = false;
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        });
    }
    
    function loadStopsOnMap() {
        fetch('/api/stops')
            .then(response => response.json())
            .then(stops => {
                // Clear existing markers
                window.stopsMarkers.forEach(marker => marker.setMap(null));
                window.stopsMarkers = [];
                
                if (stops.length > 0) {
                    const bounds = new google.maps.LatLngBounds();
                    
                    stops.forEach(stop => {
                        const marker = new google.maps.Marker({
                            position: { lat: stop.latitude, lng: stop.longitude },
                            map: window.stopsMap,
                            title: `${stop.stop_code}: ${stop.name}`,
                            icon: {
                                url: 'https://maps.google.com/mapfiles/ms/icons/bus.png',
                                scaledSize: new google.maps.Size(32, 32)
                            }
                        });
                        
                        const infoWindow = new google.maps.InfoWindow({
                            content: `
                                <div style="padding: 10px;">
                                    <h6>${stop.name}</h6>
                                    <p><strong>Code:</strong> ${stop.stop_code}</p>
                                    <p><strong>Address:</strong> ${stop.address || 'N/A'}</p>
                                    <button class="btn btn-sm btn-primary view-stop-btn" 
                                        data-stop-id="${stop.id}">View Details</button>
                                </div>
                            `
                        });
                        
                        marker.addListener('click', () => {
                            infoWindow.open(window.stopsMap, marker);
                        });
                            
                        // Add click event to the View Details button in popup
                        marker.on('popupopen', function() {
                            const popupButton = document.querySelector('.view-stop-btn');
                            if (popupButton) {
                                popupButton.addEventListener('click', function() {
                                    const stopId = this.getAttribute('data-stop-id');
                                    viewStop(stopId);
                                });
                            }
                        });
                        
                        stopsMarkers.push(marker);
                        bounds.extend([stop.latitude, stop.longitude]);
                    });
                    
                    // Fit map to show all stops
                    stopsMap.fitBounds(bounds);
                }
            })
            .catch(error => {
                console.error('Error loading stops:', error);
                alert('Failed to load stops data');
            });
    }
    
    function refreshStopsMap() {
        loadStopsOnMap();
    }
    
    function centerStopsMap() {
        if (stopsMarkers.length > 0) {
            const bounds = L.latLngBounds(stopsMarkers.map(marker => marker.getLatLng()));
            stopsMap.fitBounds(bounds);
        }
    }
    
    function saveStop() {
        // Get form values
        const stopCode = document.getElementById('stopCode').value;
        const stopName = document.getElementById('stopName').value;
        const stopAddress = document.getElementById('stopAddress').value;
        const latitude = parseFloat(document.getElementById('stopLatitude').value);
        const longitude = parseFloat(document.getElementById('stopLongitude').value);
        const isActive = document.getElementById('isActive').checked;
        
        // Validate form
        if (!stopCode || !stopName || isNaN(latitude) || isNaN(longitude)) {
            alert('Please fill all required fields with valid values');
            return;
        }
        
        // Build the stop data
        const stopData = {
            stop_code: stopCode,
            name: stopName,
            address: stopAddress,
            latitude: latitude,
            longitude: longitude,
            is_active: isActive
        };
        
        // Save stop using real API
        fetch('/api/stops/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(stopData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
                
                // Close modal and reset form
                const modal = bootstrap.Modal.getInstance(document.getElementById('addStopModal'));
                modal.hide();
                document.getElementById('addStopForm').reset();
                hideSuggestions();
                
                // Refresh the stops map and reload page
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
        });
    }
    
    function viewStop(stopId) {
        // This would be replaced with an actual API call
        fetch(`/api/stops?id=${stopId}`)
            .then(response => response.json())
            .then(stops => {
                const stop = stops.find(s => s.id == stopId);
                
                if (stop) {
                    // Populate the view modal with stop details
                    document.getElementById('viewStopCode').textContent = stop.stop_code;
                    document.getElementById('viewStopName').textContent = stop.name;
                    document.getElementById('viewStopAddress').textContent = stop.address || 'N/A';
                    document.getElementById('viewStopCoordinates').textContent = 
                        `${stop.latitude.toFixed(6)}, ${stop.longitude.toFixed(6)}`;
                    
                    // Set status badge
                    const statusElement = document.getElementById('viewStopStatus');
                    if (stop.is_active) {
                        statusElement.innerHTML = '<span class="badge bg-success">Active</span>';
                    } else {
                        statusElement.innerHTML = '<span class="badge bg-danger">Inactive</span>';
                    }
                    
                    // Initialize the map
                    const viewMap = L.map('viewStopMap').setView([stop.latitude, stop.longitude], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(viewMap);
                    
                    // Add stop marker
                    L.marker([stop.latitude, stop.longitude])
                        .bindTooltip(stop.name)
                        .addTo(viewMap);
                    
                    // Load routes for this stop
                    fetch('/api/routes')
                        .then(response => response.json())
                        .then(routes => {
                            const routesTable = document.getElementById('viewStopRoutesTable');
                            routesTable.innerHTML = '';
                            
                            let foundRoutes = false;
                            
                            routes.forEach(route => {
                                const stopsOnRoute = route.stops.filter(s => s.id === stop.id);
                                
                                stopsOnRoute.forEach(stopOnRoute => {
                                    foundRoutes = true;
                                    const row = document.createElement('tr');
                                    
                                    row.innerHTML = `
                                        <td>
                                            <span class="badge bg-primary">${route.route_number}</span>
                                            ${route.name}
                                        </td>
                                        <td>${stopOnRoute.sequence}</td>
                                        <td>${stopOnRoute.scheduled_arrival || 'N/A'}</td>
                                        <td>${stopOnRoute.scheduled_departure || 'N/A'}</td>
                                        <td>${stopOnRoute.distance_from_start ? stopOnRoute.distance_from_start + ' km' : 'N/A'}</td>
                                    `;
                                    
                                    routesTable.appendChild(row);
                                });
                            });
                            
                            if (!foundRoutes) {
                                routesTable.innerHTML = `
                                    <tr>
                                        <td colspan="5" class="text-center py-3">
                                            No routes serve this stop
                                        </td>
                                    </tr>
                                `;
                            }
                        })
                        .catch(error => {
                            console.error('Error loading routes for stop:', error);
                            document.getElementById('viewStopRoutesTable').innerHTML = `
                                <tr>
                                    <td colspan="5" class="text-center text-danger py-3">
                                        Error loading route data
                                    </td>
                                </tr>
                            `;
                        });
                    
                    // Load upcoming buses for this stop
                    fetch('/api/buses')
                        .then(response => response.json())
                        .then(buses => {
                            // In a real app, we'd fetch ETA predictions for this stop
                            // For now, we'll just show a placeholder
                            document.getElementById('viewStopBusesTable').innerHTML = `
                                <tr>
                                    <td colspan="4" class="text-center py-3">
                                        No upcoming buses scheduled at this time
                                    </td>
                                </tr>
                            `;
                        })
                        .catch(error => {
                            console.error('Error loading buses for stop:', error);
                            document.getElementById('viewStopBusesTable').innerHTML = `
                                <tr>
                                    <td colspan="4" class="text-center text-danger py-3">
                                        Error loading bus data
                                    </td>
                                </tr>
                            `;
                        });
                    
                    // Show the modal
                    const modal = new bootstrap.Modal(document.getElementById('viewStopModal'));
                    modal.show();
                    
                    // Fix map rendering issues
                    setTimeout(() => {
                        viewMap.invalidateSize();
                    }, 300);
                }
            })
            .catch(error => {
                console.error('Error fetching stop details:', error);
                alert('Failed to load stop details');
            });
    }
    
    function editStop(stopId) {
        // In a real application, this would fetch the stop data and populate the edit form
        alert(`Edit stop ${stopId} (not implemented in this demo)`);
    }
    
    function deleteStop(stopId) {
        // In a real application, this would show a confirmation dialog and then delete the stop
        if (confirm(`Are you sure you want to delete stop with ID ${stopId}?`)) {
            alert(`Stop ${stopId} deleted (simulated)`);
        }
    }
</script>
{% endblock %}
